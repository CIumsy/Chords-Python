<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chords-Python Applications</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* NPG Device Popup Styles */
        #npgDevicePopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 400px;
            max-width: 90%;
            display: none;
        }
        #npgDevicePopup h3 {
            margin-top: 0;
            color: #a855f7;
            text-align: center;
        }
        #npgDeviceList {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .npg-device-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .npg-device-item:hover {
            background: #e9ecef;
        }
        .npg-device-item.selected {
            background: #a855f7;
            color: white;
        }
        #npgPopupStatus {
            margin: 10px 0;
            min-height: 24px;
            font-weight: bold;
            text-align: center;
        }
        .scanning-status {
            color: #3b82f6;
        }
        .connected-status {
            color: #10b981;
        }
        .error-status {
            color: #ef4444;
        }
        .npg-popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .npg-popup-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .npg-connect-btn {
            background: #10b981;
            color: white;
        }
        .npg-connect-btn:disabled {
            background: #a7f3d0;
            cursor: not-allowed;
        }
        .npg-cancel-btn {
            background: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chords-Python Applications</h1>
            <p class="bottom-text">Designed with <span class="heart">&#10084;</span> at Upside Down Labs</p>
        </div>

        <!-- Pop-up message -->
        {% if message %}
        <div class="popup fade-out">
            <p>{{ message }}</p>
        </div>
        {% endif %}
        
        <div class="controls-container">
            <div class="controls">
                <button id="start_lsl_button" 
                        class="{% if lsl_started %}running{% else %}not-running{% endif %}" 
                        onclick="showCSVConfirmation()"
                        {% if lsl_started or npg_started %}disabled{% endif %}>
                    {% if lsl_started %}LSL Stream Running{% else %}Start LSL Stream{% endif %}
                </button>
            </div>
            <div class="controls">
                <button id="start_npg_button" 
                        class="{% if npg_started %}running{% else %}not-running{% endif %}"
                        onclick="showNPGPopup()"
                        {% if lsl_started or npg_started %}disabled{% endif %}>
                    {% if npg_started %}NPG Stream Running{% else %}Start NPG Stream{% endif %}
                </button>
            </div>
        </div>
        
        <!-- CSV Confirmation Popup (only for LSL) -->
        <div id="csvConfirmationPopup" class="popup" style="display: none;">
            <p>Do you want to save LSL data as CSV?</p>
            <div class="popup-buttons">
                <form id="csvForm" method="POST" action="/start_lsl">
                    <input type="hidden" name="csv" id="csvInput" value="false">
                    <button type="button" class="popup-button yes-button" onclick="setCSVChoice(true)">YES</button>
                    <button type="button" class="popup-button no-button" onclick="setCSVChoice(false)">NO</button>
                </form>
            </div>
        </div>            
        
        <div class="app-buttons {% if not (lsl_started or npg_started) %}disabled-apps{% endif %}">
            <!-- Row 1: ECG, EMG, EOG, EEG -->
            <div class="row">
                <form action="/run_app" method="POST">
                    <button type="submit" name="app_name" value="heartbeat_ecg" 
                            class="{% if 'heartbeat_ecg' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        ECG with Heart Rate
                    </button>
                    <button type="submit" name="app_name" value="emgenvelope" 
                            class="{% if 'emgenvelope' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EMG with Envelope
                    </button>
                    <button type="submit" name="app_name" value="eog" 
                            class="{% if 'eog' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EOG with Blinks
                    </button>
                    <button type="submit" name="app_name" value="ffteeg" 
                            class="{% if 'ffteeg' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG with FFT
                    </button>
                </form>
            </div>

            <!-- Row 2: Game, GUI, Keystroke, CSVPlotter -->
            <div class="row">
                <form action="/run_app" method="POST">
                    <button type="submit" name="app_name" value="game" 
                            class="{% if 'game' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG Tug of War Game
                    </button>
                    <button type="submit" name="app_name" value="beetle" 
                            class="{% if 'beetle' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG Beetle Game
                    </button>
                    <button type="submit" name="app_name" value="gui" 
                            class="{% if 'gui' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        GUI of Channels
                    </button>
                    <button type="submit" name="app_name" value="keystroke" 
                            class="{% if 'keystroke' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EOG Keystroke Emulator
                    </button>
                    <button type="submit" name="app_name" value="csvplotter" 
                            class="{% if 'csvplotter' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        CSV Plotter
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- NPG Device Selection Popup -->
    <div id="npgDevicePopup">
        <h3>Select NPG Device</h3>
        <div id="npgPopupStatus">Ready to scan devices</div>
        <div id="npgDeviceList">
            <p>Click "Scan Devices" to begin</p>
        </div>
        <div class="npg-popup-buttons">
            <button class="npg-popup-btn" id="scanDevicesBtn" onclick="scanNPGDevices()">Scan Devices</button>
            <button class="npg-popup-btn npg-connect-btn" id="npgConnectBtn" disabled onclick="connectToDevice()">Connect</button>
            <button class="npg-popup-btn npg-cancel-btn" onclick="hideNPGPopup()">Cancel</button>
        </div>
    </div>

    <script>
        let selectedDevice = null;
        let connectionCheckInterval = null;
        let eventSource;
    
        function showNPGPopup() {
            document.getElementById('npgDevicePopup').style.display = 'block';
            document.getElementById('csvConfirmationPopup').style.display = 'none';
            document.getElementById('npgPopupStatus').textContent = 'Ready to scan devices';
            document.getElementById('npgDeviceList').innerHTML = '<p>Click "Scan Devices" to begin</p>';
            document.getElementById('npgConnectBtn').disabled = true;
            selectedDevice = null;
        }
    
        function hideNPGPopup() {
            document.getElementById('npgDevicePopup').style.display = 'none';
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
                connectionCheckInterval = null;
            }
        }
    
        async function scanNPGDevices() {
            const statusDiv = document.getElementById('npgPopupStatus');
            const deviceList = document.getElementById('npgDeviceList');
            const scanBtn = document.getElementById('scanDevicesBtn');
            
            scanBtn.disabled = true;
            statusDiv.textContent = 'Scanning for devices...';
            statusDiv.className = 'scanning-status';
            deviceList.innerHTML = '<p>Searching for NPG devices...</p>';
            
            try {
                const response = await fetch('/scan_devices', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success' && data.devices.length > 0) {
                    deviceList.innerHTML = '';
                    
                    data.devices.forEach(device => {
                        const div = document.createElement('div');
                        div.className = 'npg-device-item';
                        div.textContent = `${device.name || 'Unknown'} (${device.address})`;
                        div.dataset.address = device.address;
                        
                        div.addEventListener('click', () => {
                            document.querySelectorAll('.npg-device-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            div.classList.add('selected');
                            selectedDevice = device.address;
                            document.getElementById('npgConnectBtn').disabled = false;
                        });
                        
                        deviceList.appendChild(div);
                    });
                    
                    statusDiv.textContent = `Found ${data.devices.length} device(s) - select one to connect`;
                    statusDiv.className = '';
                } else {
                    deviceList.innerHTML = '<p>No NPG devices found</p>';
                    statusDiv.textContent = data.message || 'No devices found';
                    statusDiv.className = 'error-status';
                }
            } catch (error) {
                console.error('Scan error:', error);
                deviceList.innerHTML = '<p>Scan failed</p>';
                statusDiv.textContent = 'Scan failed - please try again';
                statusDiv.className = 'error-status';
            } finally {
                scanBtn.disabled = false;
            }
        }
    
        async function connectToDevice() {
            if (!selectedDevice) return;
            
            const statusDiv = document.getElementById('npgPopupStatus');
            const connectBtn = document.getElementById('npgConnectBtn');
            const scanBtn = document.getElementById('scanDevicesBtn');
            
            connectBtn.disabled = true;
            scanBtn.disabled = true;
            statusDiv.textContent = `Connecting to device...`;
            statusDiv.className = 'scanning-status';
            
            try {
                const response = await fetch('/connect_device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `device_address=${encodeURIComponent(selectedDevice)}`
                });
                
                const data = await response.json();
                
                if (data.status === 'pending') {
                    connectionCheckInterval = setInterval(async () => {
                        const statusResponse = await fetch('/check_connection');
                        const statusData = await statusResponse.json();
                        
                        if (statusData.connected) {
                            clearInterval(connectionCheckInterval);
                            statusDiv.textContent = `Successfully connected to ${selectedDevice}`;
                            statusDiv.className = 'connected-status';
                            setTimeout(hideNPGPopup, 1500);
                        } else if (statusData.message) {
                            statusDiv.textContent = statusData.message;
                            statusDiv.className = 'error-status';
                            connectBtn.disabled = false;
                            scanBtn.disabled = false;
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Connection error:', error);
                statusDiv.textContent = 'Connection failed - please try again';
                statusDiv.className = 'error-status';
                connectBtn.disabled = false;
                scanBtn.disabled = false;
            }
        }
    
        function showCSVConfirmation() {
            document.getElementById('csvConfirmationPopup').style.display = 'block';
            document.getElementById('npgDevicePopup').style.display = 'none';
        }
    
        function setCSVChoice(saveAsCSV) {
            document.getElementById('csvInput').value = saveAsCSV ? 'true' : 'false'; 
            document.getElementById('csvForm').submit();
            document.getElementById('csvConfirmationPopup').style.display = 'none';
        }
    
        function updateAppButtons(runningApps) {
            // Get all app buttons
            const appButtons = document.querySelectorAll('.app-buttons button[type="submit"]');
            
            appButtons.forEach(button => {
                const appName = button.value;
                const isRunning = runningApps.includes(appName);
                
                if (isRunning) {
                    button.classList.add('running');
                    button.classList.remove('not-running');
                    button.textContent = button.textContent.replace('Start', 'Stop') || `Stop ${appName}`;
                } else {
                    button.classList.remove('running');
                    button.classList.add('not-running');
                    button.textContent = button.textContent.replace('Stop', 'Start') || `Start ${appName}`;
                }
            });
        }
    
        function setupEventSource() {
            if (eventSource) eventSource.close();
    
            eventSource = new EventSource('/stream_events');
            eventSource.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                // Update LSL button
                const lslButton = document.getElementById('start_lsl_button');
                if (data.lsl_running) {
                    lslButton.textContent = 'LSL Stream Running';
                    lslButton.classList.add('running');
                    lslButton.classList.remove('not-running');
                    lslButton.disabled = true;
                } else {
                    lslButton.textContent = 'Start LSL Stream';
                    lslButton.classList.remove('running');
                    lslButton.classList.add('not-running');
                    lslButton.disabled = data.npg_running;
                }
                
                // Update NPG button
                const npgButton = document.getElementById('start_npg_button');
                if (data.npg_running) {
                    npgButton.textContent = 'NPG Stream Running';
                    npgButton.classList.add('running');
                    npgButton.classList.remove('not-running');
                    npgButton.disabled = true;
                } else {
                    npgButton.textContent = 'Start NPG Stream';
                    npgButton.classList.remove('running');
                    npgButton.classList.add('not-running');
                    npgButton.disabled = data.lsl_running;
                }
                
                // Update app buttons container state
                const appButtonsDiv = document.querySelector('.app-buttons');
                if (data.lsl_running || data.npg_running) {
                    appButtonsDiv.classList.remove('disabled-apps');
                } else {
                    appButtonsDiv.classList.add('disabled-apps');
                }
                
                // Update individual app buttons
                if (data.running_apps) {
                    updateAppButtons(data.running_apps);
                }
                
                // Update status message if available
                if (data.message) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'popup fade-out';
                    messageDiv.innerHTML = `<p>${data.message}</p>`;
                    document.querySelector('.container').appendChild(messageDiv);
                    setTimeout(() => messageDiv.remove(), 3000);
                }
            };
            
            eventSource.onerror = function() {
                console.log("SSE connection error - reconnecting...");
                setTimeout(setupEventSource, 1000);
            };
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            setupEventSource();
            
            // Initial state setup
            fetch('/check_app_status')
                .then(response => response.json())
                .then(data => {
                    if (data.running_apps) {
                        updateAppButtons(data.running_apps);
                    }
                });
        });
    </script>
</body>
</html>