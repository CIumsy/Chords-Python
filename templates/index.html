<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chords Python</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-full px-8 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                    Chords Python
                </span>
            </div>
            <div class="flex space-x-4">
                <button id="github-btn" class="text-white hover:text-cyan-400 transition-colors">
                    <i class="fab fa-github text-2xl"></i>
                </button>
                <button id="info-btn" class="text-white hover:text-cyan-400 transition-colors">
                    <i class="fas fa-info-circle text-2xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-full px-8 py-6">
        <!-- Combined Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Connectivity Section -->
                <div class="flex-1">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Connectivity</h2>
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-wrap gap-2">
                            <button class="connection-btn px-4 py-2 border-2 border-cyan-500 rounded-lg flex items-center gap-2 hover:bg-cyan-500 hover:text-white transition-colors basis-[calc(33%-0.5rem)] grow text-gray-700">
                                <i class="fas fa-wifi"></i> WiFi
                            </button>
                            <button class="connection-btn px-4 py-2 border-2 border-cyan-500 rounded-lg flex items-center gap-2 hover:bg-cyan-500 hover:text-white transition-colors basis-[calc(33%-0.5rem)] grow text-gray-700">
                                <i class="fab fa-bluetooth"></i> Bluetooth
                            </button>
                            <button class="connection-btn px-4 py-2 border-2 border-cyan-500 rounded-lg flex items-center gap-2 hover:bg-cyan-500 hover:text-white transition-colors basis-[calc(33%-0.5rem)] grow text-gray-700">
                                <i class="fas fa-microchip"></i> Serial
                            </button>
                        </div>
                        <button id="connect-btn" class="w-full py-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors font-semibold">
                            Connect Device
                        </button>
                    </div>
                </div>

                <!-- Vertical Separator -->
                <div class="hidden md:block w-px bg-gray-200 mx-4 my-4"></div>

                <!-- Recording Section -->
                <div class="flex-1">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">CSV Recording</h2>
                    <div class="flex flex-col gap-4">
                        <input type="text" id="filename" value="recording_2023-11-15.csv" 
                               class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 text-lg"
                               placeholder="Enter recording name">
                        <button id="record-btn" class="w-full py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold">
                            Start Recording
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Applications</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Application Cards -->
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <img src="https://via.placeholder.com/400x200.png?text=ECG+Viewer" 
                         alt="ECG Viewer" 
                         class="w-full h-32 object-cover rounded-t-lg">
                    <div class="p-3">
                        <h3 class="font-semibold text-base mb-1">ECG Viewer</h3>
                        <p class="text-gray-600 text-sm">Real-time electrocardiogram visualization</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <img src="https://via.placeholder.com/400x200.png?text=PPG+Analyzer" 
                         alt="PPG Analyzer" 
                         class="w-full h-32 object-cover rounded-t-lg">
                    <div class="p-3">
                        <h3 class="font-semibold text-base mb-1">PPG Analyzer</h3>
                        <p class="text-gray-600 text-sm">Photoplethysmogram signal processing</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <img src="https://via.placeholder.com/400x200.png?text=EMG+Monitor" 
                         alt="EMG Monitor" 
                         class="w-full h-32 object-cover rounded-t-lg">
                    <div class="p-3">
                        <h3 class="font-semibold text-base mb-1">EMG Monitor</h3>
                        <p class="text-gray-600 text-sm">Electromyography monitoring</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <img src="https://via.placeholder.com/400x200.png?text=EDA+Chart" 
                         alt="EDA Chart" 
                         class="w-full h-32 object-cover rounded-t-lg">
                    <div class="p-3">
                        <h3 class="font-semibold text-base mb-1">EDA Chart</h3>
                        <p class="text-gray-600 text-sm">Electrodermal activity tracking</p>
                    </div>
                </div>

                <!-- Add more cards as needed -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white sticky bottom-0 z-50">
        <div class="max-w-full px-8 py-3 text-center">
            Made with ❤️ at Upside Down Labs
        </div>
    </footer>

    <script>
        // Connection type selection
        const connectionBtns = document.querySelectorAll('.connection-btn');
        let selectedConnection = null;

        connectionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                connectionBtns.forEach(b => {
                    b.classList.remove('bg-cyan-500', 'text-white');
                    b.classList.add('text-gray-700');
                });
                btn.classList.add('bg-cyan-500', 'text-white');
                btn.classList.remove('text-gray-700');
                selectedConnection = btn.textContent.trim();
            });
        });

        let selectedDevice = null;
        let connectionCheckInterval = null;
        let appStatusCheckIntervals = {};
        let isConnected = false;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Initially disable all app buttons
            disableAllAppButtons();
            
            // Set up application button event listeners
            document.querySelectorAll('.app-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    const appName = this.getAttribute('app-name');
                    if (this.classList.contains('running')) {
                        stopApp(appName);
                    } else {
                        runApp(appName);
                    }
                });
            });
            
            // Initialize CSV toggle
            document.getElementById('csvToggle').addEventListener('change', function() {
                fetch('/set_csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled: this.checked })
                });
            });
        });

        function toggleCSVRecording() {
            const recordBtn = document.getElementById('csvRecordBtn');
            const isRecording = recordBtn.classList.contains('recording');
            const filenameInput = document.getElementById('csvFilenameInput');
            
            if (isRecording) {
                // Stop recording
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'Save as CSV';
                // Add your stop recording logic here
            } else {
                // Start recording
                if (filenameInput.value.trim() === '') {
                    alert('Please enter a valid filename');
                    return;
                }
                
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'Stop Recording';
                // Add your start recording logic here
            }
        }

        function disableAllAppButtons() {
            document.querySelectorAll('.app-button').forEach(button => {
                button.disabled = true;
            });
        }

        function enableAllAppButtons() {
            document.querySelectorAll('.app-button').forEach(button => {
                button.disabled = false;
            });
        }

        function showBLEPopup() {
            document.getElementById('bleDevicePopup').style.display = 'block';
            document.getElementById('blePopupStatus').textContent = 'Ready to scan devices';
            document.getElementById('bleDeviceList').innerHTML = '<p>Click "Scan Devices" to begin</p>';
            document.getElementById('bleConnectBtn').disabled = true;
            selectedDevice = null;
        }
        
        function hideBLEPopup() {
            document.getElementById('bleDevicePopup').style.display = 'none';
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
                connectionCheckInterval = null;
            }
        }
        
        async function scanBLEDevices() {
            const statusDiv = document.getElementById('blePopupStatus');
            const deviceList = document.getElementById('bleDeviceList');
            const scanBtn = document.getElementById('scanDevicesBtn');
            
            scanBtn.disabled = true;
            statusDiv.textContent = 'Scanning for BLE devices...';
            statusDiv.className = 'scanning-status';
            deviceList.innerHTML = '<p>Searching for BLE devices...</p>';
            
            try {
                const response = await fetch('/scan_ble');
                const data = await response.json();
                
                if (data.status === 'success' && data.devices && data.devices.length > 0) {
                    deviceList.innerHTML = '';
                    
                    data.devices.forEach(device => {
                        const div = document.createElement('div');
                        div.className = 'ble-device-item';
                        div.textContent = `${device.name || 'Unknown'} (${device.address})`;
                        div.dataset.address = device.address;
                        
                        div.addEventListener('click', () => {
                            document.querySelectorAll('.ble-device-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            div.classList.add('selected');
                            selectedDevice = device.address;
                            document.getElementById('bleConnectBtn').disabled = false;
                        });
                        
                        deviceList.appendChild(div);
                    });
                    
                    statusDiv.textContent = `Found ${data.devices.length} device(s) - select one to connect`;
                    statusDiv.className = '';
                } else {
                    deviceList.innerHTML = '<p>No BLE devices found</p>';
                    statusDiv.textContent = data.message || 'No devices found';
                    statusDiv.className = 'error-status';
                }
            } catch (error) {
                console.error('Scan error:', error);
                deviceList.innerHTML = '<p>Scan failed</p>';
                statusDiv.textContent = 'Scan failed - please try again';
                statusDiv.className = 'error-status';
            } finally {
                scanBtn.disabled = false;
            }
        }
        
        async function connectToBLEDevice() {
            if (!selectedDevice) {
                alert('No BLE device selected');
                return;
            }
            
            const statusDiv = document.getElementById('blePopupStatus');
            const connectBtn = document.getElementById('bleConnectBtn');
            const scanBtn = document.getElementById('scanDevicesBtn');
            const mainStatusDiv = document.getElementById('connectionStatus');
            const disconnectButton = document.querySelector('.disconnect-button');
            const protocolGroup = document.querySelector('.protocol-connect-group');
            
            // Set initial state
            connectBtn.disabled = true;
            scanBtn.disabled = true;
            statusDiv.textContent = 'Starting BLE connection...';
            statusDiv.className = 'scanning-status';
            mainStatusDiv.textContent = 'Connecting to BLE device...';
            mainStatusDiv.className = 'scanning-status';
            
            // Set timeout for BLE connection
            const connectionTimeout = setTimeout(() => {
                statusDiv.textContent = 'BLE connection timed out (30 seconds)';
                statusDiv.className = 'error-status';
                mainStatusDiv.textContent = 'BLE connection timed out';
                mainStatusDiv.className = 'error-status';
                connectBtn.disabled = false;
                scanBtn.disabled = false;
                if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            }, 30000);

            try {
                // Start BLE connection
                const formData = new FormData();
                formData.append('address', selectedDevice);
                
                const response = await fetch('/connect_ble', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status !== 'connecting') {
                    throw new Error(data.message || 'Failed to initiate BLE connection');
                }

                // Check connection status periodically
                connectionCheckInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch('/check_connection');
                        const statusData = await statusResponse.json();
                        
                        // Update both status displays
                        updateStatusMessage(statusData.message);
                        statusDiv.textContent = statusData.message;
                        
                        if (statusData.status === 'success') {
                            // Successful connection
                            clearTimeout(connectionTimeout);
                            clearInterval(connectionCheckInterval);
                            isConnected = true;
                            
                            // Update UI
                            statusDiv.className = 'connected-status';
                            mainStatusDiv.textContent = 'BLE connection established! LSL stream started.';
                            mainStatusDiv.className = 'connected-status';
                            disconnectButton.style.display = 'block';
                            protocolGroup.style.display = 'none';
                            enableAllAppButtons();
                            
                            // Close BLE popup after short delay
                            setTimeout(() => {
                                hideBLEPopup();
                            }, 1500);
                            
                        } else if (statusData.status === 'error') {
                            // Connection failed
                            throw new Error(statusData.message);
                        }
                    } catch (error) {
                        console.error('BLE connection check error:', error);
                        statusDiv.textContent = `Error: ${error.message}`;
                        statusDiv.className = 'error-status';
                        mainStatusDiv.textContent = `BLE connection failed: ${error.message}`;
                        mainStatusDiv.className = 'error-status';
                        connectBtn.disabled = false;
                        scanBtn.disabled = false;
                        clearTimeout(connectionTimeout);
                        clearInterval(connectionCheckInterval);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('BLE connection error:', error);
                statusDiv.textContent = `BLE connection failed: ${error.message}`;
                statusDiv.className = 'error-status';
                mainStatusDiv.textContent = `BLE connection failed: ${error.message}`;
                mainStatusDiv.className = 'error-status';
                connectBtn.disabled = false;
                scanBtn.disabled = false;
                clearTimeout(connectionTimeout);
                if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            }
        }

        // Update the toggleCSVRecording function
        async function toggleCSVRecording() {
            const recordBtn = document.getElementById('csvRecordBtn');
            const isRecording = recordBtn.classList.contains('recording');
            const filenameInput = document.getElementById('csvFilenameInput');
            
            try {
                if (isRecording) {
                    // Stop recording
                    const response = await fetch('/set_csv', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ enabled: false })
                    });
                    
                    recordBtn.classList.remove('recording');
                    recordBtn.textContent = 'Record as CSV';
                    
                    // Offer to download the CSV
                    const download = confirm('Recording stopped. Would you like to download the CSV file?');
                    if (download) {
                        window.open('/download_csv', '_blank');
                    }
                } else {
                    // Start recording
                    if (filenameInput.value.trim() === '') {
                        alert('Please enter a valid filename');
                        return;
                    }
                    
                    const response = await fetch('/set_csv', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            enabled: true,
                            filename: filenameInput.value 
                        })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        recordBtn.classList.add('recording');
                        recordBtn.textContent = 'Stop Recording';
                    } else {
                        alert('Failed to start recording: ' + (data.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('CSV recording error:', error);
                alert('Error toggling CSV recording');
            }
        }

        // Update the runApp function to better handle UI states
        async function runApp(appName) {
            if (!isConnected) {
                alert('Please connect first');
                return;
            }
            
            const button = document.querySelector(`.app-button[app-name="${appName}"]`);
            button.disabled = true;
            
            try {
                const response = await fetch('/run_application', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `app_name=${encodeURIComponent(appName)}`
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    button.classList.add('running');
                    startAppStatusCheck(appName);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to run application');
            } finally {
                button.disabled = false;
            }
        }

        // Add this function to properly initialize the UI
        function initializeUI() {
            // Check connection status on page load
            fetch('/check_connection')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isConnected = true;
                        updateStatusMessage(data.message);
                        document.querySelector('.disconnect-button').style.display = 'block';
                        document.querySelector('.protocol-connect-group').style.display = 'none';
                        enableAllAppButtons();
                        
                        // Check for running apps
                        document.querySelectorAll('.app-button').forEach(button => {
                            const appName = button.getAttribute('app-name');
                            checkAppStatusOnLoad(appName);
                        });
                    }
                })
                .catch(console.error);
            
            // Initialize CSV filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').split('T').join('_').slice(0, -5);
            document.getElementById('csvFilenameInput').value = `ChordsPy_${timestamp}.csv`;
        }

        // Add this function to check app status on page load
        async function checkAppStatusOnLoad(appName) {
            try {
                const response = await fetch(`/check_app_status?app_name=${encodeURIComponent(appName)}`);
                const data = await response.json();
                
                const button = document.querySelector(`.app-button[app-name="${appName}"]`);
                
                if (data.status === 'running') {
                    button.classList.add('running');
                    startAppStatusCheck(appName);
                }
            } catch (error) {
                console.error(`Error checking status for ${appName}:`, error);
            }
        }

        async function connectWiFi() {
            const statusDiv = document.getElementById('connectionStatus');
            const wifiButton = document.getElementById('wifi_button');
            const disconnectButton = document.querySelector('.disconnect-button');
            const protocolGroup = document.querySelector('.protocol-connect-group');
            
            // Reset UI state
            wifiButton.disabled = true;
            statusDiv.textContent = 'Initializing WiFi connection...';
            statusDiv.className = 'scanning-status';
            disableAllAppButtons();
            
            // Set a timeout for the connection attempt
            const connectionTimeout = setTimeout(() => {
                statusDiv.textContent = 'WiFi connection timed out (30 seconds)';
                statusDiv.className = 'error-status';
                wifiButton.disabled = false;
                if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            }, 30000);

            try {
                // Start the connection process
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'protocol=wifi'
                });
                
                const data = await response.json();
                
                if (data.status !== 'connecting') {
                    throw new Error(data.message || 'Failed to initiate WiFi connection');
                }

                // Check connection status periodically
                connectionCheckInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch('/check_connection');
                        const statusData = await statusResponse.json();
                        
                        updateStatusMessage(statusData.message);
                        
                        if (statusData.status === 'success') {
                            // Successful connection
                            clearTimeout(connectionTimeout);
                            clearInterval(connectionCheckInterval);
                            isConnected = true;
                            
                            // Update UI
                            disconnectButton.style.display = 'block';
                            protocolGroup.style.display = 'none';
                            enableAllAppButtons();
                            
                            // Check CSV status
                            const csvResponse = await fetch('/get_csv_status');
                            const csvData = await csvResponse.json();
                            const recordBtn = document.getElementById('csvRecordBtn');
                            if (csvData.enabled) {
                                recordBtn.classList.add('recording');
                                recordBtn.textContent = 'Stop Recording';
                            }
                        } else if (statusData.status === 'error') {
                            // Connection failed
                            clearTimeout(connectionTimeout);
                            clearInterval(connectionCheckInterval);
                            throw new Error(statusData.message);
                        }
                    } catch (error) {
                        console.error('Connection check error:', error);
                        statusDiv.textContent = `Error: ${error.message}`;
                        statusDiv.className = 'error-status';
                        wifiButton.disabled = false;
                        clearTimeout(connectionTimeout);
                        clearInterval(connectionCheckInterval);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('WiFi connection error:', error);
                statusDiv.textContent = `WiFi connection failed: ${error.message}`;
                statusDiv.className = 'error-status';
                wifiButton.disabled = false;
                clearTimeout(connectionTimeout);
                if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            }
        }

        async function stopApp(appName) {
            const button = document.querySelector(`.app-button[app-name="${appName}"]`);
            button.disabled = true;
            
            try {
                const response = await fetch('/stop_application', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `app_name=${encodeURIComponent(appName)}`
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    button.classList.remove('running');
                    stopAppStatusCheck(appName);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to stop application');
            } finally {
                button.disabled = false;
            }
        }

        function startAppStatusCheck(appName) {
            stopAppStatusCheck(appName); // Clear any existing interval
            
            appStatusCheckIntervals[appName] = setInterval(async () => {
                const response = await fetch(`/check_app_status?app_name=${encodeURIComponent(appName)}`);
                const data = await response.json();
                
                const button = document.querySelector(`.app-button[app-name="${appName}"]`);
                
                if (data.status === 'running') {
                    button.classList.add('running');
                } else {
                    button.classList.remove('running');
                    stopAppStatusCheck(appName);
                }
            }, 1000);
        }

        function stopAppStatusCheck(appName) {
            if (appStatusCheckIntervals[appName]) {
                clearInterval(appStatusCheckIntervals[appName]);
                delete appStatusCheckIntervals[appName];
            }
        }
        
        async function disconnectAll() {
            const statusDiv = document.getElementById('connectionStatus');
            const disconnectBtn = document.getElementById('disconnect_button');
            
            disconnectBtn.disabled = true;
            statusDiv.textContent = 'Disconnecting and cleaning up...';
            statusDiv.className = 'scanning-status';
            const recordBtn = document.getElementById('csvRecordBtn');
            if (recordBtn.classList.contains('recording')) {
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'Save as CSV';
            }
            
            try {
                // Stop all running applications
                const runningApps = [];
                document.querySelectorAll('.app-button.running').forEach(button => {
                    runningApps.push(button.getAttribute('app-name'));
                });
                
                // Send stop commands for all running apps
                await Promise.all(runningApps.map(async (appName) => {
                    try {
                        await fetch('/stop_application', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `app_name=${encodeURIComponent(appName)}`
                        });
                    } catch (error) {
                        console.error(`Error stopping app ${appName}:`, error);
                    }
                }));
                
                // Disconnect all active connections
                try {
                    await fetch('/disconnect', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Error sending disconnect command:', error);
                }
                
                // Clear all intervals
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                    connectionCheckInterval = null;
                }
                
                for (const appName in appStatusCheckIntervals) {
                    clearInterval(appStatusCheckIntervals[appName]);
                    delete appStatusCheckIntervals[appName];
                }
                
                // Refresh the page after a brief delay
                statusDiv.textContent = 'Cleanup complete - refreshing page...';
                statusDiv.className = '';
                
                setTimeout(() => {
                    window.location.reload(true); // true forces a hard refresh from server
                }, 1000);
                
            } catch (error) {
                console.error('Disconnection error:', error);
                statusDiv.textContent = 'Disconnection failed - refreshing anyway';
                statusDiv.className = 'error-status';
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            }
}
        
        function updateStatusMessage(message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = message;
            
            if (message.includes('established') || message.includes('success')) {
                statusDiv.className = 'connected-status';
            } else if (message.includes('Error') || message.includes('Failed')) {
                statusDiv.className = 'error-status';
            } else {
                statusDiv.className = 'scanning-status';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>