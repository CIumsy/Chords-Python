<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chords-Python Applications</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        button:disabled {
            opacity: 1;
            cursor: not-allowed;
        }
        .disabled-apps button {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chords-Python Applications</h1>
            <p class="bottom-text">Designed with <span class="heart">&#10084;</span> at Upside Down Labs</p>
        </div>

        <!-- Pop-up message -->
        {% if message %}
        <div class="popup fade-out">
            <p>{{ message }}</p>
        </div>
        {% endif %}
        
        <div class="controls-container">
            <div class="controls">
                <button id="start_lsl_button" 
                        class="{% if lsl_started %}running{% else %}not-running{% endif %}" 
                        onclick="showCSVConfirmation()"
                        {% if lsl_started or npg_started %}disabled{% endif %}>
                    {% if lsl_started %}LSL Stream Running{% else %}Start LSL Stream{% endif %}
                </button>
            </div>
            <div class="controls">
                <form action="/start_npg" method="POST">
                    <button type="submit" id="start_npg_button" 
                            class="{% if npg_started %}running{% else %}not-running{% endif %}"
                            {% if lsl_started or npg_started %}disabled{% endif %}>
                        {% if npg_started %}NPG Stream Running{% else %}Start NPG Stream{% endif %}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- CSV Confirmation Popup (only for LSL) -->
        <div id="csvConfirmationPopup" class="popup" style="display: none;">
            <p>Do you want to save LSL data as CSV?</p>
            <div class="popup-buttons">
                <form id="csvForm" method="POST" action="/start_lsl">
                    <input type="hidden" name="csv" id="csvInput" value="false">
                    <button type="button" class="popup-button yes-button" onclick="setCSVChoice(true)">YES</button>
                    <button type="button" class="popup-button no-button" onclick="setCSVChoice(false)">NO</button>
                </form>
            </div>
        </div>            
        
        <div class="app-buttons {% if not (lsl_started or npg_started) %}disabled-apps{% endif %}">
            <!-- Row 1: ECG, EMG, EOG, EEG -->
            <div class="row">
                <form action="/run_app" method="POST">
                    <button type="submit" name="app_name" value="heartbeat_ecg" 
                            class="{% if 'heartbeat_ecg' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        ECG with Heart Rate
                    </button>
                    <button type="submit" name="app_name" value="emgenvelope" 
                            class="{% if 'emgenvelope' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EMG with Envelope
                    </button>
                    <button type="submit" name="app_name" value="eog" 
                            class="{% if 'eog' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EOG with Blinks
                    </button>
                    <button type="submit" name="app_name" value="ffteeg" 
                            class="{% if 'ffteeg' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG with FFT
                    </button>
                </form>
            </div>

            <!-- Row 2: Game, GUI, Keystroke, CSVPlotter -->
            <div class="row">
                <form action="/run_app" method="POST">
                    <button type="submit" name="app_name" value="game" 
                            class="{% if 'game' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG Tug of War Game
                    </button>
                    <button type="submit" name="app_name" value="beetle" 
                            class="{% if 'beetle' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EEG Beetle Game
                    </button>
                    <button type="submit" name="app_name" value="gui" 
                            class="{% if 'gui' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        GUI of Channels
                    </button>
                    <button type="submit" name="app_name" value="keystroke" 
                            class="{% if 'keystroke' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        EOG Keystroke Emulator
                    </button>
                    <button type="submit" name="app_name" value="csvplotter" 
                            class="{% if 'csvplotter' in running_apps %}running{% else %}not-running{% endif %}" 
                            {% if not (lsl_started or npg_started) %}disabled{% endif %}>
                        CSV Plotter
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
        function showCSVConfirmation() {document.getElementById('csvConfirmationPopup').style.display = 'block';}
    
        function setCSVChoice(saveAsCSV) {
            document.getElementById('csvInput').value = saveAsCSV ? 'true' : 'false'; 
            document.getElementById('csvForm').submit();
            document.getElementById('csvConfirmationPopup').style.display = 'none';
        }

        function updateAllStatuses() {
            fetch("/app_status")
                .then(response => response.json())
                .then(data => {
                    const lslRunning = data.lsl_started || false;
                    const npgRunning = data.npg_started || false;
                    
                    const lslButton = document.getElementById("start_lsl_button");
                    const npgButton = document.getElementById("start_npg_button");
                    
                    if (lslRunning) {
                        lslButton.classList.add("running");
                        lslButton.classList.remove("not-running");
                        lslButton.textContent = "LSL Stream Running";
                        lslButton.disabled = true;
                    } else {
                        lslButton.classList.remove("running");
                        lslButton.classList.add("not-running");
                        lslButton.textContent = "Start LSL Stream";
                        lslButton.disabled = npgRunning;
                    }
                    
                    if (npgRunning) {
                        npgButton.classList.add("running");
                        npgButton.classList.remove("not-running");
                        npgButton.textContent = "NPG Stream Running";
                        npgButton.disabled = true;
                    } else {
                        npgButton.classList.remove("running");
                        npgButton.classList.add("not-running");
                        npgButton.textContent = "Start NPG Stream";
                        npgButton.disabled = lslRunning;
                    }

                    const appButtons = document.querySelectorAll('.app-buttons button');
                    const appsEnabled = lslRunning || npgRunning;
                    
                    appButtons.forEach(button => {button.disabled = !appsEnabled;});
                    
                    const appButtonsDiv = document.querySelector('.app-buttons');
                    if (appsEnabled) {appButtonsDiv.classList.remove('disabled-apps');} 
                    else {appButtonsDiv.classList.add('disabled-apps');}

                    Object.keys(data).forEach(app => {
                        if (app !== 'lsl_started' && app !== 'npg_started') {
                            const button = document.querySelector(`button[value="${app}"]`);
                            if (button) {
                                if (data[app]) {
                                    button.classList.add("running");
                                    button.classList.remove("not-running");
                                } else {
                                    button.classList.add("not-running");
                                    button.classList.remove("running");
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error("Error:", error));
        }
        function checkAppStatus() {
            fetch("/check_app_status")
                .then(response => response.json())
                .then(data => {
                    const runningApps = data.running_apps || [];
                    
                    // Update all app buttons
                    document.querySelectorAll('.app-buttons button').forEach(button => {
                        const appName = button.value;
                        if (runningApps.includes(appName)) {
                            button.classList.add("running");
                            button.classList.remove("not-running");
                        } else {
                            button.classList.remove("running");
                            button.classList.add("not-running");
                        }
                    });
                });
        }
        
        document.addEventListener("DOMContentLoaded", () => {
        setInterval(checkAppStatus, 200);
        });

        setInterval(updateAllStatuses, 100);
        document.addEventListener("DOMContentLoaded", updateAllStatuses);
    </script>  
</body>
</html>